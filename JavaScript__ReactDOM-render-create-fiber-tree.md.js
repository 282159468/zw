(self["webpackChunkzw"]=self["webpackChunkzw"]||[]).push([[8239],{34221:function(e,n,t){"use strict";t.r(n);var r=t(67294),o=t(96089),l=t(65659);t(53132);n["default"]=e=>(r.useEffect((()=>{var n;null!==e&&void 0!==e&&null!==(n=e.location)&&void 0!==n&&n.hash&&o.AnchorLink.scrollToAnchor(decodeURIComponent(e.location.hash.slice(1)))}),[]),r.createElement(r.Fragment,null,r.createElement("div",{className:"markdown"},r.createElement("h2",{id:"\u521d\u59cb\u5316-workinprogress"},r.createElement(o.AnchorLink,{to:"#\u521d\u59cb\u5316-workinprogress","aria-hidden":"true",tabIndex:-1},r.createElement("span",{className:"icon icon-link"})),"\u521d\u59cb\u5316 workInProgress"),r.createElement("p",null,"\u7406\u89e3\u4e3a\u6b63\u5728\u8fdb\u7a0b\u4e2d\u7684\u4efb\u52a1\uff0cworkInProgress \u5c31\u662f\u4e00\u4e2a Fiber \u5bf9\u8c61\uff0c\u53ef\u4ee5\u7b80\u5355\u7684\u628a\u4ed6\u7406\u89e3\u4e3a\u5168\u5c40\u53d8\u91cf\uff1b\u9996\u6b21\u6e32\u67d3\u4f1a\u901a\u8fc7 RootFiber \u521d\u59cb\u5316 workInProgress\uff0c"),r.createElement("p",null,"\u8fd9\u91cc\u7684 RootFiber \u89c6\u4e3a current\uff0c\u521b\u5efa\u597d\u7684 workInProgress \u548c current \u4e92\u4e3a\u66ff\u8eab alternate\uff0c\u5373\uff1a"),r.createElement(l.Z,{code:"function ReactDOM_render() {\n  prepareFreshStack();\n}\n\n// \u6839\u636eRootFiber\u521b\u5efaworkInProgress\nfunction prepareFreshStack(root: FiberRoot) {\n  workInProgress = createWorkInProgress(root.current, null);\n  // current = RootFiber\n  // \u4e92\u4e3a\u66ff\u8eab\uff0c\u540e\u7eed\u521b\u5efa\u7684fiber\u8282\u70b9\u7b49\u7b49\u90fd\u662f\u6302\u5728current.alternate\n  // \u5982\u679c\u6700\u7ec8\u5b8c\u6210\u66f4\u65b0\u4f1a\u7528alternate\u66ff\u6362current\n  workInProgress.alternate = current;\n  current.alternate = workInProgress;\n  workInProgress = RootFiber;\n  workLoopSync();\n}",lang:"js"}),r.createElement("p",null,"\u4e0b\u9762\u4f1a\u901a\u8fc7 workLoopSync \u5728 workInProgress \u4e0a\u9012\u5f52\u521b\u5efa child Fiber\uff0c\u6ce8\u610f\u8fd9\u91cc\u7684 workInProgress \u53ea\u662f RootFiber \u7684\u66ff\u8eab(RootFiber.alternate)\uff0c\u800c\u4e0d\u662f RootFiber \u672c\u8eab"),r.createElement("h2",{id:"\u6267\u884c\u9012\u5f52"},r.createElement(o.AnchorLink,{to:"#\u6267\u884c\u9012\u5f52","aria-hidden":"true",tabIndex:-1},r.createElement("span",{className:"icon icon-link"})),"\u6267\u884c\u9012\u5f52"),r.createElement("p",null,"workLoopSync \u4ece \u521d\u59cb\u5316\u7684 workInProgress(RootFiber)\u5f00\u59cb\u5faa\u73af\u6267\u884c\u540c\u6b65\u4efb\u52a1:"),r.createElement(l.Z,{code:"function workLoopSync() {\n  while (workInProgress !== null) {\n    performUnitOfWork(workInProgress);\n  }\n}",lang:"js"}),r.createElement("p",null,"\u5f00\u59cb\u6267\u884c\u5355\u5143\u4efb\u52a1"),r.createElement(l.Z,{code:"function performUnitOfWork(unitOfWork: Fiber): void {\n  // \u83b7\u53d6Fiber\u5f53\u524d\u72b6\u6001\uff0c\u73b0\u9636\u6bb5\u770b\u5230\u7684\u7528\u5904\u662f\uff0c\u7528\u6765\u786e\u5b9aeffectTag\u7c7b\u578b\n  // \u7b2c\u4e00\u6b21\u5faa\u73af\u662fRootFiberClone.alternate = RootFiber\n  // \u4ece\u7b2c\u4e8c\u6b21\u5f00\u59cbFiber\u7684alternate\u90fd\u4e3a\u7a7a\n  // \u4e0b\u9762placeSingleChild\u4e2d\u7684shouldTrackSideEffects === !!current\n  const current = unitOfWork.alternate;\n  let next;\n  if (enableProfilerTimer && (unitOfWork.mode & ProfileMode) !== NoMode) {\n    next = beginWork(current, unitOfWork, renderExpirationTime);\n  } else {\n    next = beginWork(current, unitOfWork, renderExpirationTime);\n  }\n  unitOfWork.memoizedProps = unitOfWork.pendingProps;\n  if (next === null) {\n    completeUnitOfWork(unitOfWork);\n  } else {\n    workInProgress = next;\n  }\n}",lang:"js"}),r.createElement("h2",{id:"beginwork-\u9636\u6bb5"},r.createElement(o.AnchorLink,{to:"#beginwork-\u9636\u6bb5","aria-hidden":"true",tabIndex:-1},r.createElement("span",{className:"icon icon-link"})),"beginWork \u9636\u6bb5"),r.createElement("p",null,"beginWork \u4f1a\u5b9e\u4f8b\u5316\u7ec4\u4ef6(new)\uff0c\u628a\u5b9e\u4f8b\u8d4b\u503c\u7ed9 Fiber.stateNode\uff1b"),r.createElement("p",null,"\u8c03\u7528\u7ec4\u4ef6 render \u51fd\u6570\uff0c\u51fd\u6570\u7ec4\u4ef6\u76f4\u63a5\u6267\u884c\uff0c\u83b7\u53d6\u5230 ReactElment\uff0c\u7136\u540e\u4ece\u5916\u5230\u5185\u904d\u5386 ReactElment \u6839\u636e\u4e0d\u540c\u7684 ReactElment.type \u521b\u5efa\u4e0d\u540c\u7c7b\u578b\u7684 Fiber"),r.createElement("p",null,"beginWork \u53e6\u5916\u4e00\u4e2a\u4f5c\u7528\u662f\u901a\u8fc7\u51fd\u6570 placeSingleChild \u6253 effectTag\uff0c\u5176\u4e2d\u7684 shouldTrackSideEffects \u7531",r.createElement("code",null,"workInProgress.alternate"),"\u662f\u5426\u6709\u503c\u51b3\u5b9a\u3002"),r.createElement("blockquote",null,r.createElement("p",null,"\u5728 performUnitOfWork \u4e2d",r.createElement("code",null,"const current = unitOfWork.alternate;"))),r.createElement("p",null,"\u800c\u5728\u9996\u6b21\u6e32\u67d3\u65f6\u53ea\u6709 RootFiber.alternate \u6709\u503c\uff0c\u6240\u4ee5 AppFiber.effectTag = Placement = 2"),r.createElement("p",null,"\u6ce8\uff1a\u56e0\u4e3a\u662f\u9996\u6b21\u6e32\u67d3\u90fd\u662f\u7531 placeSingleChild \u6765\u6253\u6807\u8bb0\uff0c\u66f4\u65b0\u6e32\u67d3\u65f6\u4f1a\u6709\u5176\u4ed6\u5f62\u5f0f\u7684\u6807\u8bb0"),r.createElement(l.Z,{code:"function placeSingleChild(newFiber: Fiber): Fiber {\n  if (shouldTrackSideEffects && newFiber.alternate === null) {\n    newFiber.effectTag = Placement;\n  }\n  return newFiber;\n}\n\n// \u5982\u679c\u662f\u7c7b\u7ec4\u4ef6\u4e14componentDidMount\uff0c\u9700\u8981\u52a0\u4e0aUpdate(4)\nif (typeof instance.componentDidMount === 'function') {\n  workInProgress.effectTag |= Update;\n}\n// \u7edf\u4e00\u52a0\u4e0a1\nworkInProgress.effectTag |= PerformedWork;",lang:"js"}),r.createElement("h3",{id:"\u7c7b\u7ec4\u4ef6\u751f\u547d\u5468\u671f"},r.createElement(o.AnchorLink,{to:"#\u7c7b\u7ec4\u4ef6\u751f\u547d\u5468\u671f","aria-hidden":"true",tabIndex:-1},r.createElement("span",{className:"icon icon-link"})),"\u7c7b\u7ec4\u4ef6\u751f\u547d\u5468\u671f"),r.createElement(l.Z,{code:"let instance = workInProgress.stateNode;\nif (instance === null) {\n  instance = new ctor(props, context);\n  ctor.getDerivedStateFromProps(nextProps, prevState);\n  // In order to support react-lifecycles-compat polyfilled components,\n  // Unsafe lifecycles should not be invoked for components using the new APIs.\n  // \u4f7f\u7528\u65b0\u5468\u671f\u5c31\u4e0d\u4f1a\u6267\u884c\u65e7\u7684\u751f\u547d\u5468\u671f\n  if (\n    typeof ctor.getDerivedStateFromProps !== 'function' &&\n    typeof instance.getSnapshotBeforeUpdate !== 'function' &&\n    (typeof instance.UNSAFE_componentWillMount === 'function' ||\n      typeof instance.componentWillMount === 'function')\n  ) {\n    componentWillMount(workInProgress, instance);\n  }\n  workInProgress.stateNode = instance;\n}\n// \u6700\u540e\u6267\u884crender\u51fd\u6570\u83b7\u53d6Element\u521b\u5efa\u5b50Fiber\nconst next = instance.render();",lang:"js"}),r.createElement("h2",{id:"jsx-\u793a\u4f8b"},r.createElement(o.AnchorLink,{to:"#jsx-\u793a\u4f8b","aria-hidden":"true",tabIndex:-1},r.createElement("span",{className:"icon icon-link"})),"JSX \u793a\u4f8b"),r.createElement(l.Z,{code:'<div>\n  <span id="S1">\n    <i>A</i>\n  </span>\n  <span id="S2">B</span>\n  <span id="S3">C</span>\n</div>',lang:"jsx"}),r.createElement("ol",null,r.createElement("li",null,r.createElement("p",null,"beginWork \u521b\u5efa DivFiber")),r.createElement("li",null,r.createElement("p",null,"beginWork \u521b\u5efa S1Fiber\uff0cS2Fiber\uff0cS3Fiber \u4e09\u4e2a Fiber\uff0cElement \u7684 props \u662f","{","children:[]","}"),r.createElement("p",null,"DivFiber.child = S1Fiber"),r.createElement("p",null,"S1Fiber.return = DivFiber"),r.createElement("p",null,"S1Fiber.sibling = S2Fiber"),r.createElement("p",null,"S2Fiber.sibling = S3Fiber")),r.createElement("li",null,r.createElement("p",null,"beginWork \u521b\u5efa IFiber"),r.createElement("p",null,"S1Fiber.child = IFiber"),r.createElement("p",null,"IFiber.return = S1Fiber")),r.createElement("li",null,r.createElement("p",null,"i \u6807\u7b7e\u4e0b\u9762\u6ca1\u6709\u5b50\u8282\u70b9\uff0c\u6240\u4ee5\u6d41\u7a0b\u8df3\u8f6c\u5230 completeWork\uff0c\u5982\u679c\u8fd9\u91cc S2\u3001S3 \u8fd8\u6709\u5b50\u8282\u70b9\u4e5f\u4f1a\u8df3\u8f6c\u5230 completeWork"))),r.createElement(l.Z,{code:"function beginWork() {\n  switch (workInProgress.tag) {\n    case IndeterminateComponent: {\n    }\n    case LazyComponent: {\n    }\n    case FunctionComponent: {\n    }\n    case ClassComponent: {\n    }\n    case HostRoot:\n      return updateHostRoot(current, workInProgress, renderExpirationTime);\n    case HostComponent:\n    case HostText:\n    case SuspenseComponent:\n    case HostPortal:\n  }\n}",lang:"js"}),r.createElement("h2",{id:"completework-\u9636\u6bb5"},r.createElement(o.AnchorLink,{to:"#completework-\u9636\u6bb5","aria-hidden":"true",tabIndex:-1},r.createElement("span",{className:"icon icon-link"})),"completeWork \u9636\u6bb5"),r.createElement("p",null,"completeWork \u4ee5\u4ece\u5185\u5230\u5916\u7684\u65b9\u5f0f\u9012\u5f52\uff0c\u521b\u5efa DOM \u8282\u70b9\uff0c\u7ed9\u8282\u70b9\u6dfb\u52a0\u5185\u5bb9\uff0c\u5904\u7406 style\u3001dangerouslySetInnerHTML\u3001Event \u7b49\u4efb\u52a1"),r.createElement("blockquote",null,r.createElement("p",null,"React \u4e2d DOM \u6dfb\u52a0\u6587\u672c\u5185\u5bb9\u4f7f\u7528\u7684\u662f textContent \u8fd9\u4e2a API\uff0ctextContent \u5e76\u4e0d\u4f1a\u50cf innerHTML \u628a\u5185\u5bb9\u89e3\u6790\u4e3a HTML\uff0c\u8fd9\u6837\u6027\u80fd\u9ad8\u8fd8\u53ef\u4ee5\u9632\u6b62 XSS\uff0c\u9700\u8981\u6ce8\u610f innerText \u548c textContent \u7684\u533a\u522b")),r.createElement("p",null,"\u5176\u4e2d\u9700\u8981\u5904\u7406\u4e00\u4e9b\u7279\u6b8a\u60c5\u51b5\uff0c\u6bd4\u5982\uff1a"),r.createElement("ul",null,r.createElement("li",null,"ReactDOM.createProtal()"),r.createElement("li",null,"input\u3001textarea")),r.createElement("p",null,"\u521b\u5efa\u5b8c\u6210\u6700\u540e\uff0c\u901a\u8fc7\u5224\u65ad Fiber.child \u662f\u5426\u6709\u503c\uff0c\u6709\u7684\u8bdd\u6267\u884c appendAllChildren \u628a DOM \u4e00\u6b65\u4e00\u6b65\u5f80\u4e0a\u6dfb\u52a0\uff0c"),r.createElement(l.Z,{code:"function appendAllChildren(Fiber) {\n  if (Fiber.child) {\n    Fiber.stateNode.appendChild(Fiber.child.stateNode);\n  }\n}",lang:"js"}),r.createElement("p",null,"\u63a5\u4e0a\u9762\u7b2c 4 \u6b65"),r.createElement("ol",{start:5},r.createElement("li",null,r.createElement("p",null,"completeWork \u521b\u5efa i"),r.createElement(l.Z,{code:"const instance = document.createElement('i');\ninstance.textContent = 'A';\nIFiber.stateNode = instance;\nappendAllChildren(IFiber);",lang:"js"})),r.createElement("li",null,r.createElement("p",null,"i \u6ca1\u6709\u5144\u5f1f\u8282\u70b9\u8fd4\u56de\u5230\u7236\u7ea7\uff0ccompleteWork \u521b\u5efa span"),r.createElement(l.Z,{code:"const instance = document.createElement('span');\nS1Fiber.stateNode = instance;\nappendAllChildren(S1Fiber);",lang:"js"})),r.createElement("li",null,r.createElement("p",null,"S1 \u6709\u5144\u5f1f\u8282\u70b9 S2\uff0cworkInProgerss = S2\uff0cworkLoopSync \u5faa\u73af\u7ee7\u7eed"))),r.createElement("p",null,"\u91cd\u590d 5\uff0c6\uff0c7 \u6b65\u9aa4"),r.createElement("p",null,"\u4e0a\u9762\u7684 JSX \u793a\u4f8b\u4e2d\u5168\u662f DOM \u8282\u70b9\uff0c\u6ca1\u6709\u7ec4\u4ef6\u8c03\u7528\uff0c\u5176\u5b9e\u7ec4\u4ef6\u8c03\u7528\u5728 complateWork \u9636\u6bb5\u57fa\u672c\u5565\u4e5f\u4e0d\u5e72\uff0c"),r.createElement("p",null,r.createElement("code",null,"<Button/>"),"\u5176\u6700\u7ec8\u7ed3\u679c\u5c31\u662f React Element\uff0c\u800c\u5728 beginWork \u9636\u6bb5\u5c31\u4f7f\u7528 Element \u628a Fiber \u521b\u5efa\u597d\u4e86"),r.createElement("ol",{start:8},r.createElement("li",null,r.createElement("p",null,"S3 \u6ca1\u6709\u5144\u5f1f\u8282\u70b9\u8fd4\u56de\u5230\u7236\u7ea7\uff0ccompleteWork \u521b\u5efa div"),r.createElement(l.Z,{code:"const instance = document.createElement('div');\nS1Fiber.stateNode = instance;\nappendAllChildren(DivFiber);",lang:"js"})),r.createElement("li",null,r.createElement("p",null,"\u5411\u4e0a\u9012\u5f52\u5230 RootFiber\uff0c\u6ca1\u6709\u5144\u5f1f\u3001\u7236\u4eb2\u5faa\u73af\u7ed3\u675f"))),r.createElement(l.Z,{code:"function completeUnitOfWork() {\n  do {\n    next = completeWork(current, completedWork, renderExpirationTime);\n    // \u6709\u5b50\u8282\u70b9\u7ee7\u7eed\u5904\u7406\n    if (next !== null) {\n      workInProgress = next;\n      return;\n    }\n\n    // \u5904\u7406\u526f\u4f5c\u7528\n    if (\n      returnFiber !== null &&\n      (returnFiber.effectTag & Incomplete) === NoEffect\n    ) {\n      if (returnFiber.firstEffect === null) {\n        returnFiber.firstEffect = completedWork.firstEffect;\n      }\n      if (completedWork.lastEffect !== null) {\n        if (returnFiber.lastEffect !== null) {\n          returnFiber.lastEffect.nextEffect = completedWork.firstEffect;\n        }\n        returnFiber.lastEffect = completedWork.lastEffect;\n      }\n\n      const effectTag = completedWork.effectTag;\n\n      if (effectTag > PerformedWork) {\n        if (returnFiber.lastEffect !== null) {\n          returnFiber.lastEffect.nextEffect = completedWork;\n        } else {\n          returnFiber.firstEffect = completedWork;\n        }\n        returnFiber.lastEffect = completedWork;\n      }\n    }\n\n    // \u6ca1\u6709\u5b50\u8282\u70b9\uff0c\u63a5\u7740\u5904\u7406\u5144\u5f1f\u8282\u70b9\n    if (siblingFiber !== null) {\n      workInProgress = siblingFiber;\n      return;\n    }\n    // \u6ca1\u6709\u5144\u5f1f\u8282\u70b9\u8fd4\u56de\u7236\u7ea7\uff0cworkLoopSync\u8fdb\u5165\u4e0b\u4e00\u6b21\u5faa\u73af\n    completedWork = returnFiber;\n    // Update the next thing we're working on in case something throws.\n    workInProgress = completedWork;\n  } while (completedWork !== null);\n}",lang:"js"}),r.createElement("h2",{id:"\u603b\u7ed3"},r.createElement(o.AnchorLink,{to:"#\u603b\u7ed3","aria-hidden":"true",tabIndex:-1},r.createElement("span",{className:"icon icon-link"})),"\u603b\u7ed3"),r.createElement("ul",null,r.createElement("li",null,"\u4e3b\u8981\u5206\u4e3a beginWork\u3001completeWork"),r.createElement("li",null,"\u901a\u8fc7",r.createElement("code",null,"<App/>"),"\u83b7\u53d6\u5230\u6574\u4e2a\u5e94\u7528 React Element"),r.createElement("li",null,"beginWork \u7531 RootFiber \u5f00\u59cb\uff0c\u6839\u636e Element \u4ece\u4e0a\u5230\u4e0b\u521b\u5efa Fiber \u8282\u70b9\uff0c\u5f53\u67d0\u5b50\u8282\u70b9\u6ca1\u6709\u5b50\u8282\u70b9\u65f6\u8f6c\u5230 completeWork"),r.createElement("li",null,"completeWork \u4f1a\u521d\u59cb\u5316 Fiber.stateNode \u5c5e\u6027\uff0c\u5373\u521b\u5efa\u5b8c\u6210 DOM \u4e8b\u4ef6\u3001\u6837\u5f0f\u3001\u5185\u5bb9\u7b49"),r.createElement("li",null,"\u5982\u679c\u5f53\u524d\u8282\u70b9\u6709 siblingFiber \u4f1a\u8f6c\u5230 beginWork(siblingFiber) \u7ee7\u7eed\u521b\u5efa\u8be5\u5206\u652f Fiber \u8282\u70b9"),r.createElement("li",null,"\u53cd\u4e4b\u901a\u8fc7 returnFiber \u7ee7\u7eed completeWork\uff0c\u4e00\u76f4\u9012\u5f52\u5230 RootFiber \u5b8c\u6210\u521b\u5efa"),r.createElement("li",null,"\u521b\u5efa\u5b8c\u6210\u540e\u7684 Fiber Tree \u6307\u5411\u7684\u662f RootFiber.alternate")),r.createElement("h2",{id:"\u53e6\u4e00\u4e2a\u793a\u4f8b"},r.createElement(o.AnchorLink,{to:"#\u53e6\u4e00\u4e2a\u793a\u4f8b","aria-hidden":"true",tabIndex:-1},r.createElement("span",{className:"icon icon-link"})),"\u53e6\u4e00\u4e2a\u793a\u4f8b"),r.createElement(l.Z,{code:"export default class App extends React.PureComponent {\n  constructor() {\n    super();\n    this.state = { a: 0 };\n  }\n\n  render() {\n    return (\n      <div>\n        <span>{this.state.a}</span>\n        <A num={this.state.a} />\n        <C count={this.state.a} />\n      </div>\n    );\n  }\n}\n\nfunction C() {\n  return (\n    <div>\n      <span>c-span</span>\n      <i>c-i</i>\n    </div>\n  );\n}\n\nclass A extends React.PureComponent {\n  render() {\n    return <div>AAA</div>;\n  }\n}",lang:"jsx"}),r.createElement("p",null,"\u6e32\u67d3\u5165\u53e3\u8c03\u7528 prepareFreshStack\uff0c\u521d\u59cb\u5316 workInProgress"),r.createElement(l.Z,{code:"function ReactDOM_render() {\n  prepareFreshStack();\n}\n\nfunction prepareFreshStack() {\n  workInProgress = createFiber();\n  // current = RootFiber\n  // \u4e92\u4e3a\u66ff\u8eab\uff0c\u540e\u7eed\u521b\u5efa\u7684fiber\u8282\u70b9\u7b49\u7b49\u90fd\u662f\u6302\u5728current.alternate\n  // \u5982\u679c\u6700\u7ec8\u5b8c\u6210\u66f4\u65b0\u4f1a\u7528alternate\u66ff\u6362current\n  workInProgress.alternate = current;\n  current.alternate = workInProgress;\n  workInProgress = RootFiber;\n  workLoopSync();\n}\n\n// workLoopSync \u4ece RootFiber \u5f00\u59cb\u5faa\u73af\u6267\u884c\u540c\u6b65\u4efb\u52a1:\nfunction workLoopSync() {\n  while (workInProgress !== null) {\n    performUnitOfWork(workInProgress);\n  }\n}\n\n// \u5f00\u59cb\u6267\u884c\u5355\u5143\u4efb\u52a1\nfunction performUnitOfWork(unitOfWork: Fiber): void {\n  //\n  const current = unitOfWork.alternate;\n  let next;\n  if (enableProfilerTimer && (unitOfWork.mode & ProfileMode) !== NoMode) {\n    next = beginWork(current, unitOfWork, renderExpirationTime);\n  } else {\n    next = beginWork(current, unitOfWork, renderExpirationTime);\n  }\n  unitOfWork.memoizedProps = unitOfWork.pendingProps;\n  if (next === null) {\n    completeUnitOfWork(unitOfWork);\n  } else {\n    workInProgress = next;\n  }\n}\n\nfunction beginWork() {\n  switch (workInProgress.tag) {\n    case IndeterminateComponent: {\n    }\n    case LazyComponent: {\n    }\n    case FunctionComponent: {\n    }\n    case ClassComponent: {\n    }\n    case HostRoot:\n      return updateHostRoot(current, workInProgress, renderExpirationTime);\n    case HostComponent:\n    case HostText:\n    case SuspenseComponent:\n    case HostPortal:\n  }\n}\n\nfunction completeUnitOfWork() {\n  do {\n    // completeWork\u5185\u7684\u5206\u652f\u5927\u90e8\u5206\u90fd\u8fd4\u56denull\uff0c\u53ea\u6709\u4e2a\u522b\u60c5\u51b5\u6709\u503c\uff0c\u731c\u6d4b\u662frender\u4e2d\u6709\u4ea7\u751f\u65b0\u7684\u66f4\u65b0\n    next = completeWork(current, completedWork, renderExpirationTime);\n    // \u6709\u5b50\u8282\u70b9\u7ee7\u7eed\u5904\u7406\n    if (next !== null) {\n      workInProgress = next;\n      return;\n    }\n    // \u6ca1\u6709\u5b50\u8282\u70b9\uff0c\u63a5\u7740\u5904\u7406\u5144\u5f1f\u8282\u70b9\n    if (siblingFiber !== null) {\n      workInProgress = siblingFiber;\n      return;\n    }\n    // \u6ca1\u6709\u5144\u5f1f\u8282\u70b9\u8fd4\u56de\u7236\u7ea7\uff0cworkLoopSync\u8fdb\u5165\u4e0b\u4e00\u6b21\u5faa\u73af\n    // \u76f4\u5230RootFiber.return = null\u9000\u51fa\u5faa\u73af\n    completedWork = returnFiber;\n    // Update the next thing we're working on in case something throws.\n    workInProgress = completedWork;\n  } while (completedWork !== null);\n}",lang:"js"}),r.createElement("p",null,"\u5165\u53e3\u6267\u884c ReactDOM.render \u5f00\u59cb\u521b\u5efa Fiber \u6811\uff0c\u4ece\u4e0a RootFiber \u5230\u4e0b\u5f00\u59cb\u521b\u5efa Fiber"),r.createElement("h2",{id:"1"},r.createElement(o.AnchorLink,{to:"#1","aria-hidden":"true",tabIndex:-1},r.createElement("span",{className:"icon icon-link"})),"1"),r.createElement(l.Z,{code:"workInProgress = RootFiber = {\n  stateNode: FiberRootNode,\n};\n\nconst ClassAppFiber = {\n  type: ClassApp,\n  stateNode: new ClassApp(),\n};\nconst next = ClassAppFiber;\nRootFiber.child = next;\nworkInProgress = next;",lang:"js"}),r.createElement("h2",{id:"2"},r.createElement(o.AnchorLink,{to:"#2","aria-hidden":"true",tabIndex:-1},r.createElement("span",{className:"icon icon-link"})),"2"),r.createElement(l.Z,{code:"const divfiber = {\n  type: `div`,\n  pendingProps: {\n    children: [\n      { $$typeof: Symbol(react.element), type: 'span' },\n      // ...\n      {\n        $$typeof: Symbol(react.element),\n        props: { count: 0 },\n        type: ClassA,\n      },\n\n      {\n        $$typeof: Symbol(react.element),\n        props: { count: 0 },\n        type: FuncC,\n      },\n    ],\n  },\n  stateNode: document.createComment('div'),\n};\nconst next = divfiber;\nClassAppFiber.child = next;\nworkInProgress = next;",lang:"js"}),r.createElement("h2",{id:"3"},r.createElement(o.AnchorLink,{to:"#3","aria-hidden":"true",tabIndex:-1},r.createElement("span",{className:"icon icon-link"})),"3"),r.createElement("p",null,"\u8fd9\u4e00\u6b65\u6709\u70b9\u7279\u6b8a\uff0c\u7531\u4e8e workInProgress = divfiber\uff0c\u4ed6\u7684 pendingProps.children \u662f\u6570\u7ec4\u6240\u4ee5\u4f1a\u8c03\u7528\u4e00\u4e2a",r.createElement("code",null,"reconcileChildrenArray"),"\u7684\u65b9\u6cd5\u5904\u7406\u5144\u5f1f\u8282\u70b9\u5173\u7cfb\uff0c\u53ef\u4ee5\u770b\u5230\u8fd9\u6b65\u662f\u4e00\u4e0b\u521b\u5efa\u4e86\u540c\u7ea7\u6240\u6709\u5144\u5f1f Fiber"),r.createElement(l.Z,{code:"function reconcileChildrenArray(returnFiber) {\n  for (; newIdx < newChildren.length; newIdx++) {\n    const newFiber = createChild(returnFiber);\n    if (previousNewFiber === null) {\n      resultingFirstChild = newFiber;\n    } else {\n      previousNewFiber.sibling = newFiber;\n    }\n    previousNewFiber = newFiber;\n  }\n  return resultingFirstChild;\n}\n// spanFiber\u5c31\u662fresultingFirstChild\n// \u8fd9\u91cc\u5c31\u53ef\u4ee5\u770b\u51fachild\u662f\u6307\u5411\u7b2c\u4e00\u4e2a\u5b50\u8282\u70b9\n// \u7136\u540e\u9012\u5f52\u7684\u65f6\u5019\u901a\u8fc7sibling\u5904\u7406\u6240\u6709\u5144\u5f1f\u8282\u70b9\nconst spanFiber = {\n  type: `span`,\n  pendingProps: { children: 0 },\n};\nconst next = spanFiber;\nClassAppFiber.child = next;\nworkInProgress = next;",lang:"js"}),r.createElement("h2",{id:"4"},r.createElement(o.AnchorLink,{to:"#4","aria-hidden":"true",tabIndex:-1},r.createElement("span",{className:"icon icon-link"})),"4"),r.createElement("p",null,"\u5904\u7406 spanFiber \u8282\u70b9"),r.createElement(l.Z,{code:"const instance = document.createElement('span');\ninstance.textContent = '0';\nappendAllChildren(instance, workInProgress, false, false);\n\n// HOST\u7c7b\u578b\u7ec4\u4ef6\u5176\u5b9e\u5c31\u662fDOM\u8282\u70b9\nspanFiber.stateNode = instance;\n\nconst appendAllChildren = function(\n  parent: Instance,\n  workInProgress: Fiber,\n  needsVisibilityToggle: boolean,\n  isHidden: boolean,\n) {\n  let node = workInProgress.child;\n  while (node !== null) {\n    if (node.tag === HostComponent || node.tag === HostText) {\n      appendInitialChild(parent, node.stateNode);\n    }\n    if (node === workInProgress) {\n      return;\n    }\n    while (node.sibling === null) {\n      if (node.return === null || node.return === workInProgress) {\n        return;\n      }\n      node = node.return;\n    }\n    // \u8bbe\u7f6e\u5144\u5f1f\u7684\u7236\u8282\u70b9\n    node.sibling.return = node.return;\n    // \u7ee7\u7eed\u9012\u5f52\u5144\u5f1f\u8282\u70b9\n    node = node.sibling;\n  }\n};",lang:"js"}),r.createElement("p",null,"\u5904\u7406\u5b8c\u540e\u8fd4\u56de null\uff0c\u5373 next \u4e3a\u7a7a\uff0c\u5faa\u73af\u8fdb\u5165 completeUnitOfWork \u5206\u652f\uff0c\u8fd9\u65f6 workInProgress \u8fd8\u662f\u7b49\u4e8e spanFiber"))))}}]);