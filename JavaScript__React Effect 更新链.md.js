(self["webpackChunkzw"]=self["webpackChunkzw"]||[]).push([[6108],{87024:function(e,t,n){"use strict";n.r(t);var r=n(67294),l=n(96089),c=n(65659);n(53132);t["default"]=e=>(r.useEffect((()=>{var t;null!==e&&void 0!==e&&null!==(t=e.location)&&void 0!==t&&t.hash&&l.AnchorLink.scrollToAnchor(decodeURIComponent(e.location.hash.slice(1)))}),[]),r.createElement(r.Fragment,null,r.createElement("div",{className:"markdown"},r.createElement("h2",{id:"fiber-\u4e2d\u7684\u526f\u4f5c\u7528"},r.createElement(l.AnchorLink,{to:"#fiber-\u4e2d\u7684\u526f\u4f5c\u7528","aria-hidden":"true",tabIndex:-1},r.createElement("span",{className:"icon icon-link"})),"Fiber \u4e2d\u7684\u526f\u4f5c\u7528"),r.createElement("h2",{id:"\u521b\u5efa-effect-\u94fe"},r.createElement(l.AnchorLink,{to:"#\u521b\u5efa-effect-\u94fe","aria-hidden":"true",tabIndex:-1},r.createElement("span",{className:"icon icon-link"})),"\u521b\u5efa Effect \u94fe"),r.createElement("p",null,"\u521b\u5efa Effect \u94fe\u662f\u5728 completeWork \u8fc7\u7a0b\u4e2d\u8fdb\u884c\u7684\uff0c\u6240\u4ee5\u4e3a\u6df1\u5ea6\u4f18\u5148\u7684\u904d\u5386\uff0c\u4ece\u6700\u5185\u5c42\u5f00\u59cb\u521b\u5efa effect \u94fe"),r.createElement(c.Z,{code:"function completeUnitOfWork(unitOfWork: Fiber): void {\n  let completedWork = unitOfWork;\n  do {\n    const current = completedWork.alternate;\n    const returnFiber = completedWork.return;\n    // \u526f\u4f5c\u7528\u4e2d\u4e0d\u5305\u62ec\u5f02\u5e38\n    if ((completedWork.effectTag & Incomplete) === NoEffect) {\n      next = completeWork(current, completedWork, renderExpirationTime);\n      if (next !== null) {\n        workInProgress = next;\n        return;\n      }\n\n      if (\n        returnFiber !== null &&\n        // \u5982\u679c\u7236\u8282\u70b9\u6709\u5f02\u5e38\u4e0d\u4f1a\u5904\u7406\u4e86\n        (returnFiber.effectTag & Incomplete) === NoEffect\n      ) {\n        // \u81ea\u8eab\u5b50\u8282\u70b9\u6709\u66f4\u65b0\n        // \u5982\u679ccompletedWork\u7684\u5b50\u8282\u70b9\u6709\u66f4\u65b0\uff0c\u8fd9\u4e9b\u66f4\u65b0\u662f\u6302\u5728completedWork.firstEffect\u4e0a\u7684\uff0c\n        // returnFiber.firstEffect\u5c31\u7b49\u4e8ecompletedWork.firstEffect\n        if (returnFiber.firstEffect === null) {\n          returnFiber.firstEffect = completedWork.firstEffect;\n        }\n        // \u975e\u6700\u5185\u5c42\u65f6 completedWork.lastEffect\u53ef\u80fd\u6709\u503c\n        if (completedWork.lastEffect !== null) {\n          // \u975e\u7b2c\u4e00\u6b21\uff0c\u94fe\u63a5\u5c3e\u9996\n          if (returnFiber.lastEffect !== null) {\n            returnFiber.lastEffect.nextEffect = completedWork.firstEffect;\n          }\n          // \u7b2c\u4e00\u6b21\u521d\u59cb\u5316\u7236\u8282\u70b9lastEffect\u7b49\u5f53\u524d\u8282\u70b9completedWork.lastEffect\n          returnFiber.lastEffect = completedWork.lastEffect;\n        }\n\n        // \u81ea\u8eab\u6709\u66f4\u65b0\n        const effectTag = completedWork.effectTag;\n        if (effectTag > PerformedWork) {\n          // lastEffect\u4e0d\u4e3a\u7a7a\uff0cfirstEffect\u80af\u5b9a\u4e5f\u4e0d\u7a7a\n          if (returnFiber.lastEffect !== null) {\n            // \u5904\u7406\u540c\u7ea7\u7684\u66f4\u65b0\u94fe prevCompletedWork.nextEffect = completedWork\n            returnFiber.lastEffect.nextEffect = completedWork;\n          } else {\n            returnFiber.firstEffect = completedWork;\n          }\n          returnFiber.lastEffect = completedWork;\n        }\n      }\n    } else {\n      // \u6709\u5f02\u5e38\u7684\u60c5\u51b5\n    }\n\n    const siblingFiber = completedWork.sibling;\n    if (siblingFiber !== null) {\n      workInProgress = siblingFiber;\n      return;\n    }\n    completedWork = returnFiber;\n    workInProgress = completedWork;\n  } while (completedWork !== null);\n}",lang:"js"}),r.createElement("p",null,"\u4f8b\u5b50"),r.createElement(c.Z,{code:"import React, { PureComponent } from 'react';\n\nexport default class App extends PureComponent {\n  constructor() {\n    super();\n    this.state = {\n      color: 'red',\n      size: 'big',\n    };\n  }\n\n  componentDidMount() {\n    this.setState({ color: 'blue', size: 'small' });\n  }\n\n  render() {\n    const { color, size } = this.state;\n    return (\n      <div className={size}>\n        {size === 'big' && <b>size=small</b>}\n        {size === 'small' && <i>size=small</i>}\n        <Foo color={color} />\n      </div>\n    );\n  }\n}\n\nconst Foo = ({ color }) => {\n  return [<p style={{ color }}>AAA</p>, <span style={{ color }}>BBB</span>];\n};",lang:"jsx"}),r.createElement("p",null,"\u4e0a\u9762\u4e24\u4e2a\u7ec4\u4ef6\u4f1a\u521b\u5efa\u4ee5\u4e0b Fiber \u8282\u70b9"),r.createElement("ul",null,r.createElement("li",null,"RootFiber"),r.createElement("li",null,"App-fiber"),r.createElement("li",null,"div-fiber"),r.createElement("li",null,"b-fiber"),r.createElement("li",null,"i-fiber"),r.createElement("li",null,"Foo-fiber"),r.createElement("li",null,"p-fiber"),r.createElement("li",null,"span-fiber")),r.createElement("h2",{id:"\u9996\u6b21\u6e32\u67d3-effect-\u94fe"},r.createElement(l.AnchorLink,{to:"#\u9996\u6b21\u6e32\u67d3-effect-\u94fe","aria-hidden":"true",tabIndex:-1},r.createElement("span",{className:"icon icon-link"})),"\u9996\u6b21\u6e32\u67d3 Effect \u94fe"),r.createElement("p",null,"\u6253 effectTag \u6807\u8bb0\u662f\u6839\u636e shouldTrackSideEffects \u51b3\u5b9a\u7684\uff0cworkInProgress.alternate \u6709\u503c\u65f6 shouldTrackSideEffects \u4e3a true\uff0c \u9996\u6b21\u6e32\u67d3\u65f6\u53ea\u6709 RootFiber.alternate \u6709\u503c"),r.createElement(c.Z,{code:"function placeSingleChild(newFiber: Fiber): Fiber {\n  if (shouldTrackSideEffects && newFiber.alternate === null) {\n    newFiber.effectTag = Placement;\n  }\n  return newFiber;\n}",lang:"js"}),r.createElement("p",null,"\u6240\u4ee5\u53ea\u6709 RootFiber \u7684\u5b50\u8282\u70b9 App-fiber.effectTag \u5927\u4e8e PerformedWork"),r.createElement("p",null,"\u56e0\u4e3a\u53ea\u6709 App-fiber.effectTag \u81ea\u8eab\u6709\u66f4\u65b0\uff0c\u6240\u4ee5\u53ea\u6709 RootFiber.firstEffect=App-fiber\uff0c"),r.createElement("p",null,"\u5176\u4ed6 Fiber.firstEffect \u90fd\u662f null"),r.createElement("p",null,"\u5c0f\u7ed3\uff1a"),r.createElement("ul",null,r.createElement("li",null,"\u53ea\u6709\u4e00\u4e2a\u5b50\u8282\u70b9\u65f6 firstEffect \u548c lastEffect \u662f\u76f8\u7b49\u7684"),r.createElement("li",null,"\u9996\u6b21\u6e32\u67d3\u53ea\u6709 RootFiber.firstEffect \u6709\u503c"),r.createElement("li",null,"\u968f\u540e\u7684 commit phase \u5c31\u53ef\u4ee5\u6839\u636e RootFiber.firstEffect \u8fdb\u884c\u771f\u5b9e DOM \u6dfb\u52a0\u4e86")),r.createElement("h2",{id:"\u4e8c\u6b21\u66f4\u65b0-effect-\u94fe"},r.createElement(l.AnchorLink,{to:"#\u4e8c\u6b21\u66f4\u65b0-effect-\u94fe","aria-hidden":"true",tabIndex:-1},r.createElement("span",{className:"icon icon-link"})),"\u4e8c\u6b21\u66f4\u65b0 Effect \u94fe"),r.createElement(c.Z,{code:"if (returnFiber.firstEffect === null) {\n  returnFiber.firstEffect = completedWork.firstEffect;\n}\n/**\n * \u5904\u7406\u5b50\u8282\u70b9\u6709\u66f4\u65b0\n * \u5f53\u524d\u8282\u70b9\u4e0d\u662f\u53f6\u5b50\u8282\u70b9\u7684\u60c5\u51b5\uff0c\u4e0d\u662f\u53f6\u5b50\u8282\u70b9completedWork.lastEffect\u624d\u53ef\u80fd\u6709\u503c\n */\nif (completedWork.lastEffect !== null) {\n  // \u5b58\u5728lastEffect\u60c5\u51b5\u94fe\u63a5\u5c3e\u9996\n  if (returnFiber.lastEffect !== null) {\n    returnFiber.lastEffect.nextEffect = completedWork.firstEffect;\n  }\n  // \u7236\u7ea7lastEffect\u6307\u5411\u5f53\u524d\u5c42lastEffect\n  returnFiber.lastEffect = completedWork.lastEffect;\n}\n\n/**\n * \u81ea\u8eab\u6709\u66f4\u65b0\n * \u628a\u81ea\u8eab\u66f4\u65b0\u6dfb\u52a0\u5230\u4e0a\u5c42\n */\nconst effectTag = completedWork.effectTag;\nif (effectTag > PerformedWork) {\n  if (returnFiber.lastEffect !== null) {\n    returnFiber.lastEffect.nextEffect = completedWork;\n  } else {\n    returnFiber.firstEffect = completedWork;\n  }\n  returnFiber.lastEffect = completedWork;\n}",lang:"js"}),r.createElement("p",null,"Effect \u94fe\u591a\u6570\u5728 complateWork \u4e2d\u5b8c\u6210\u66f4\u65b0\uff0c\u6709\u4e00\u4e2a\u4f8b\u5916\uff0c\u5220\u9664\u7c7b\u578b\u7684\u526f\u4f5c\u7528\u5728 beginWork \u8c03\u5ea6\u5b50\u8282\u70b9\u4e2d\u5904\u7406"),r.createElement(c.Z,{code:"function deleteChild(returnFiber: Fiber, childToDelete: Fiber): void {\n  if (!shouldTrackSideEffects) {\n    return;\n  }\n  const last = returnFiber.lastEffect;\n  if (last !== null) {\n    // \u4e4b\u524d\u7236\u8282\u70b9\u7684lastEffect.nextEffect\u6307\u5411\u8be5\u8282\u70b9\n    last.nextEffect = childToDelete;\n    // \u628a\u8981\u5220\u9664\u7684\u8282\u70b9\u66f4\u65b0\u5230\u7236\u8282\u70b9lastEffect\u4e0a\n    returnFiber.lastEffect = childToDelete;\n  } else {\n    // \u8ddf\u4e0a\u9762\u5957\u8def\u4e00\u6837firstEffect->N1Fiber->nextEffect->N2Fiber->...->lastEffect\n    returnFiber.firstEffect = returnFiber.lastEffect = childToDelete;\n  }\n  childToDelete.nextEffect = null;\n  // \u8fd9\u91cc\u5e76\u6ca1\u6709\u771f\u6b63\u5220\u9664Fiber\u8282\u70b9\uff0c\u53ea\u662f\u6253\u6807\u8bb0\n  childToDelete.effectTag = Deletion;\n}",lang:"js"}),r.createElement("h3",{id:"completedwork--i-fiber"},r.createElement(l.AnchorLink,{to:"#completedwork--i-fiber","aria-hidden":"true",tabIndex:-1},r.createElement("span",{className:"icon icon-link"})),"completedWork = i-fiber"),r.createElement("p",null,"\u4e8c\u6b21\u66f4\u65b0 alternate \u6811\u4e0a\u6ca1\u6709 b-fiber \u4e86\uff0c\u6240\u4ee5\u7b2c\u4e00\u4e2a\u5faa\u73af\u5904\u7406\u7684\u5c31\u662f i-fiber"),r.createElement("blockquote",null,r.createElement("p",null,"div-fiber.lastEffect = div-fiber.firstEffect = b-fiber")),r.createElement("p",null,r.createElement("strong",null,"\u5b50\u8282\u70b9\u66f4\u65b0")),r.createElement("p",null,"\u65e0\uff08i-fiber \u662f\u53f6\u5b50\uff09"),r.createElement("p",null,r.createElement("strong",null,"\u81ea\u8eab\u66f4\u65b0")),r.createElement("p",null,"div-fiber.lastEffect(b-fiber).nextEffect = completedWork;"),r.createElement("p",null,"div-fiber.lastEffect = completedWork;"),r.createElement("h2",{id:"\u81ea\u7b54\u9898"},r.createElement(l.AnchorLink,{to:"#\u81ea\u7b54\u9898","aria-hidden":"true",tabIndex:-1},r.createElement("span",{className:"icon icon-link"})),"\u81ea\u7b54\u9898"),r.createElement("ul",{className:"contains-task-list"},r.createElement("li",{className:"task-list-item"},r.createElement("input",{type:"checkbox",disabled:!0})," \u4e3a\u4ec0\u4e48\u66f4\u65b0\u65f6 Foo \u7684 effecTage = 1"),r.createElement("li",{className:"task-list-item"},r.createElement("input",{type:"checkbox",disabled:!0})," i-fiber.nextEffect = p-fiber"),r.createElement("li",{className:"task-list-item"},r.createElement("input",{type:"checkbox",disabled:!0})," \u4e3a\u4ec0\u4e48",r.createElement("code",null,"{"," false &&</i> ","}"),"\u4e0d\u4f1a\u663e\u793a false")))))}}]);