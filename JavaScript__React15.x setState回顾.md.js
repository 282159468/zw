(self["webpackChunkzw"]=self["webpackChunkzw"]||[]).push([[7914],{22231:function(e,t,n){"use strict";n.d(t,{m:function(){return a.m}});var a=n(9684);n(72255)},82656:function(e,t,n){"use strict";n.r(t);var a=n(67294),l=n(96089),c=n(72350),r=n(65659),s=n(53132),i=a.memo(s.default["React15.x setState\u56de\u987e-demo"].component);t["default"]=e=>(a.useEffect((()=>{var t;null!==e&&void 0!==e&&null!==(t=e.location)&&void 0!==t&&t.hash&&l.AnchorLink.scrollToAnchor(decodeURIComponent(e.location.hash.slice(1)))}),[]),a.createElement(a.Fragment,null,a.createElement(a.Fragment,null,a.createElement("div",{className:"markdown"},a.createElement("p",null,"\u524d\u51e0\u5929\u8bfb\u4e86 React16.x \u7684 useState \u6e90\u7801\uff0c\u5176\u4e2d\u65f6\u4e0d\u65f6\u78b0\u5230 Fiber\uff0c\u4f46 16 \u7684 Fiber \u4e00\u5757\u5f88\u96be\u5543\u7684\uff0c\u4e00\u76f4\u6ca1\u6709\u653b\u4e0b\u6765\uff0c\u5543 Fiber \u4e4b\u524d\u81ea\u5df1\u60f3\u56de\u987e\u4e0b React15.x \u7684 setState \u6279\u91cf\u66f4\u65b0\uff0c\u4e3a\u8bfb Fiber \u505a\u51c6\u5907")),a.createElement(c.default,s.default["React15.x setState\u56de\u987e-demo"].previewerProps,a.createElement(i,null)),a.createElement("div",{className:"markdown"},a.createElement("p",null,"onClick \u4e2d\u7684 this.setState(","{"," a: this.state.a + 1 ","}",");\u6267\u884c\u540e\uff0c\u5e38\u89c4\u7406\u89e3\u8fd9\u65f6\u8f93\u51fa state \u4e2d a \u7684\u503c\u5e94\u8be5\u5c31\u662f 2 \u4e86\uff0c\u4f46\u5b9e\u9645\u8f93\u51fa\u7684\u8fd8\u662f 1\u3002\u4e3a\u4ec0\u4e48\u4f1a\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\uff0c\u80af\u5b9a\u5c31\u662f setState \u628a\u6570\u636e\u4fdd\u5b58\u4e0b\u6765\u4e86\uff0c\u56e0\u4e3a React \u51fa\u4e8e\u6027\u80fd\u8003\u8651\uff0c\u591a\u4e8e\u540c\u4e00\u4e2a\u4efb\u52a1\u4e2d\u6267\u884c\u591a\u6b21 setState\uff0c\u6700\u7ec8\u5168\u5408\u5e76\u4e3a\u4e00\u6b21\u5bf9\u754c\u9762\u8fdb\u884c\u5237\u65b0"),a.createElement("p",null,"\u6267\u884c setState \u540e\u6700\u7ec8\u4f1a\u8fdb\u5165"),a.createElement(r.Z,{code:"var queue =\n  internalInstance._pendingStateQueue ||\n  (internalInstance._pendingStateQueue = []);\nqueue.push(partialState);\n// partialState\u7684\u503c\u5c31\u662fsetState({a:this.state.a+1})\u4e2d\u53c2\u6570\u5bf9\u8c61\uff0c\n// \u6240\u4ee5internalInstance._pendingStateQueue = [{a:2}]\nReactUpdates.enqueueUpdate(internalInstance);\n\nfunction enqueueUpdate(component) {\n  ensureInjected();\n\n  if (!batchingStrategy.isBatchingUpdates) {\n    batchingStrategy.batchedUpdates(enqueueUpdate, component);\n    return;\n  }\n  dirtyComponents.push(component);\n}",lang:"js"}),a.createElement("p",null,"\u7531\u4e8e batchingStrategy.isBatchingUpdates \u4e3a true,\u7136\u540e\u6267\u884c\u5b8c dirtyComponents.push(component)\u540e\u6574\u4e2a setState()\u64cd\u4f5c\u5c31\u5b8c\u6210\u4e86\uff0c\u8fd9\u91cc\u53c8\u4ea7\u751f\u4e24\u4e2a\u95ee\u9898"),a.createElement("ul",null,a.createElement("li",null,"batchingStrategy.isBatchingUpdates \u662f\u5728\u4ec0\u4e48\u65f6\u5019\u8bbe\u7f6e\u4e3a true \u7684"),a.createElement("li",null,"setState \u6574\u4e2a\u8c03\u7528\u6267\u884c\u5b8c\u4e86\u4e5f\u6ca1\u770b\u5230\u66f4\u65b0 state \u503c\uff0c\u4f46\u6700\u7ec8 render \u65f6 state \u7684\u503c\u8f93\u51fa\u662f 2\uff0c\u662f\u5728\u4ec0\u4e48\u65f6\u5019\u5904\u7406\u7684")),a.createElement("h2",{id:"isbatchingupdates-\u4ec0\u4e48\u65f6\u5019\u8d4b\u503c\u4e3a-true"},a.createElement(l.AnchorLink,{to:"#isbatchingupdates-\u4ec0\u4e48\u65f6\u5019\u8d4b\u503c\u4e3a-true","aria-hidden":"true",tabIndex:-1},a.createElement("span",{className:"icon icon-link"})),"isBatchingUpdates \u4ec0\u4e48\u65f6\u5019\u8d4b\u503c\u4e3a true"),a.createElement("p",null,"\u56e0\u4e3a React \u5408\u6210\u4e8b\u4ef6\uff0c\u6d3e\u53d1 onClick \u7684\u4e8b\u4ef6\u662f\u5b9e\u9645\u4e0a\u6267\u884c\u4e86"),a.createElement(r.Z,{code:"dispatchEvent: function (topLevelType, nativeEvent) {\n    if (!ReactEventListener._enabled) {\n      return;\n    }\n\n    var bookKeeping = TopLevelCallbackBookKeeping.getPooled(topLevelType, nativeEvent);\n    try {\n        // \u8fd9\u53e5\u7684\u610f\u601d\u5c31\u662f\u6211\u8981\u5f00\u59cb\u4e00\u4e2a\u6279\u91cf\u66f4\u65b0\u4e86\n      batchingStrategy.batchedUpdates(handleTopLevelImpl, bookKeeping);\n    } finally {\n      TopLevelCallbackBookKeeping.release(bookKeeping);\n    }\n  }",lang:"js"}),a.createElement(r.Z,{code:"var ReactDefaultBatchingStrategy = {\n  isBatchingUpdates: false,\n  batchedUpdates: function(callback, a, b, c, d, e) {\n    var alreadyBatchingUpdates = ReactDefaultBatchingStrategy.isBatchingUpdates;\n    // \u8fd9\u91cc\u8d4b\u503c\uff0c\u8868\u793a\u5f53\u524d\u5904\u4e8e\u6279\u91cf\u66f4\u65b0\u4e2d\n    ReactDefaultBatchingStrategy.isBatchingUpdates = true;\n\n    if (alreadyBatchingUpdates) {\n      return callback(a, b, c, d, e);\n    } else {\n      return transaction.perform(callback, null, a, b, c, d, e);\n    }\n  },\n};",lang:"js"}),a.createElement("p",null,"\u6709\u4e86\u4ee5\u4e0a\u4e24\u6b65\u7ecf\u8fc7\u5408\u6210\u4e8b\u4ef6\u6700\u7ec8\u89e6\u53d1\u4e86 onClick \u5904\u7406\u51fd\u6570\uff0c\u518d\u6267\u884c setState(","{","}",")\uff0c\u7136\u540e\u8fdb\u5165 enqueueUpdate \u8fd9\u91cc\u5224\u65ad isBatchingUpdates \u5c31\u4e3a true\uff0c\u628a setState(","{","a:this.state.a+1","}",")=>setState(","{","a:2","}",")\u7684\u6570\u636e\u7b80\u5355\u7684\u6dfb\u52a0\u5230 dirtyComponents.push(component)\uff0ccomponent._pendingStateQueue = [","{","a:2","}","]\uff0c\u6240\u4ee5\u8fd9\u91cc\u8f93\u51fa state.a \u7684\u503c\u8fd8\u662f\u4e4b\u524d\u7684\u503c"),a.createElement("h2",{id:"\u4ec0\u4e48\u65f6\u5019\u66f4\u65b0\u4e86-state-\u6570\u636e"},a.createElement(l.AnchorLink,{to:"#\u4ec0\u4e48\u65f6\u5019\u66f4\u65b0\u4e86-state-\u6570\u636e","aria-hidden":"true",tabIndex:-1},a.createElement("span",{className:"icon icon-link"})),"\u4ec0\u4e48\u65f6\u5019\u66f4\u65b0\u4e86 state \u6570\u636e"),a.createElement("p",null,"\u8981\u7406\u6e05\u8fd9\u4e2a\uff0c\u9996\u5148\u8981\u7406\u89e3\u4e8b\u52a1 Transaction\uff0c\u7b80\u5355\u8bf4\u4e8b\u52a1\u5c31\u662f\u7ed9\u4e00\u4e2a\u51fd\u6570\u6dfb\u52a0 wrapper\uff0cwrapper \u5206 before\u3001after,\u8981\u6267\u884c\u8fd9\u4e2a\u51fd\u6570\uff0c\u9996\u5148\u6267\u884c beforeWrapper=>fn=>afterWrapper"),a.createElement(r.Z,{code:"function fn() {\n  console.log(1);\n}\n\nconst wrappers = [\n  { before: () => console.log(0), after: () => console.log(2) },\n];\n\nconst transaction = new Transaction(fn, wrappers);\ntransaction.perform(fn);\n// 0\n// 1\n// 2",lang:"js"}),a.createElement("p",null,"\u6d3e\u53d1\u4e8b\u4ef6\u4e2d batchingStrategy.batchedUpdates \u5c31\u5f00\u542f\u4e86\u4e00\u4e2a\u4e8b\u52a1 transaction.perform(callback, null, a, b, c, d, e)\uff0c\u4e3b\u8981\u5173\u6ce8\u5b9e\u4f8b\u5316 transaction \u65f6\u7684 wrapper"),a.createElement(r.Z,{code:"// initialize\u3001colse\u76f8\u5f53\u4e8e\u4e0a\u9762\u7406\u89e3\u7684beforeWrapper\u3001afterWrapper\nvar RESET_BATCHED_UPDATES = {\n  initialize: emptyFunction,\n  close: function() {\n    ReactDefaultBatchingStrategy.isBatchingUpdates = false;\n  },\n};\n\nvar FLUSH_BATCHED_UPDATES = {\n  initialize: emptyFunction,\n  close: ReactUpdates.flushBatchedUpdates.bind(ReactUpdates),\n};\n\nvar TRANSACTION_WRAPPERS = [FLUSH_BATCHED_UPDATES, RESET_BATCHED_UPDATES];",lang:"js"}),a.createElement("p",null,"FLUSH_BATCHED_UPDATES \u7684 colse \u5b9a\u4e49\u4e86 ReactUpdates.flushBatchedUpdates\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u4f1a\u5728\u4e8b\u4ef6\u5904\u7406\u51fd\u6570\u6267\u884c\u5b8c\u540e\u6267\u884c\u3002"),a.createElement(r.Z,{code:"var flushBatchedUpdates = function() {\n  while (dirtyComponents.length || asapEnqueued) {\n    if (dirtyComponents.length) {\n      var transaction = ReactUpdatesFlushTransaction.getPooled();\n      transaction.perform(runBatchedUpdates, null, transaction);\n      ReactUpdatesFlushTransaction.release(transaction);\n    }\n\n    if (asapEnqueued) {\n      asapEnqueued = false;\n      var queue = asapCallbackQueue;\n      asapCallbackQueue = CallbackQueue.getPooled();\n      queue.notifyAll();\n      CallbackQueue.release(queue);\n    }\n  }\n};",lang:"js"}),a.createElement("p",null,"dirtyComponents \u5c31\u662f enqueueUpdate \u4e2d\u4fdd\u5b58\u7684\u810f\u7ec4\u4ef6\uff0c\u6700\u540e\u66f4\u65b0 state")))))}}]);